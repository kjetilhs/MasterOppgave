\chapter{Path and Navigation}
\section{Path system}\label{Ch:LandingPath}
The path system consist of two main parts, which the landing path and the approach path. The landing path is a straight line path orientated with respect to a reference net position. The approach path is design separately as a lateral Dubins path and a longitudinal straight line path. The approach path is designed to ensure that the \gls{uav} is able to enter the landing path at the correct height with the correct attitude.
\subsection{Landing Path}\label{SS:netApproach}
The landing path is inspired by the work done in \citep{Skulstad&Syversen} where waypoint was used to create a straight line path towards the net. This method proved successful, and thus this landing system continues on the work. The angles in the straight line path must be kept small to avoid large transition behaviour from switching way-point, however the trade off is that the start high in of the landing path must be above any obstacles that is around the landing area. At sea this could be other ships or platforms, and on land it could be threes or hills. The straight line path is constructed relative to the net as shown in figure \ref{Fig:LandingPhase}, with way-points given as:
\begin{subequations}
\begin{align}
&\mathbf{WP4} = 
\begin{bmatrix}
-a0 \\
0 \\
h_{nc} + a1\tan(\gamma_n) 
\end{bmatrix}\\
&\mathbf{WP3} = 
\begin{bmatrix}
a1 \\
0 \\
h_{nc} - a1\tan(\gamma_n)
\end{bmatrix}\\
&\mathbf{WP2} = \mathbf{WP3} + 
\begin{bmatrix}
a2 \\
0 \\
-a2\tan(\gamma_l)
\end{bmatrix}\\
&\mathbf{WP1} = \mathbf{WP2} + 
\begin{bmatrix}
a3 \\
0 \\
0 \\
\end{bmatrix}
\end{align}
\end{subequations}
where the description of the parameters used is given in table \ref{Tb:Approach Parameters}. The net is placed between the fourth and third way points such that transitional behaviour do not occur during the finale stage of the net landing.
\begin{table}[H]
\begin{center}
    \begin{tabular}{ | l | l |}
    \hline
    \textbf{Parameter} & \textbf{Description} \\ \hline
    $h_{nc}$ & The height from ground to the net center \\ \hline
    $a0$ & The distance behind the net \\ \hline
    $a1$ & The distance in front of the net \\ \hline
    $a2$ & The length of the glide slope \\ \hline
    $a3$ & The length of the approach towards the glide slope \\ \hline
    $\gamma_n$ & The net attack angle \\ \hline
    $\gamma_l$ & The landing glide slope angle \\ \hline
    \end{tabular}
\end{center}
\caption{Net approach parameters }
\label{Tb:Approach Parameters}
\end{table}
The way point vectors are rotated into the NED frame by a rotation around the z-axes.
\begin{equation}
\mathbf{WP}^n = \mathbf{R}(\psi_{net})\mathbf{WP}^b
\end{equation}
were $\psi_{net}$ is the heading of the net, and $\mathbf{R}(\psi_{net})$ is the standard rotation matrix around the z-axis.
\begin{figure}
\def\svgwidth{\textwidth} % Defining the width since Inkscape hasn't done this yet in the .pdf_tex file
\input{InkFig/LandingPhase.pdf_tex}
\caption{The landing path}
\label{Fig:LandingPhase}
\end{figure}

\subsection{Approach path}\label{SS:LandingApproach}
The landing path is separated into two parts, which is a lateral and longitudinal path. The purpose of the path is to ensure that the \gls{uav} can enter the landing path at the correct height with the correct attitude from any initial position. The lateral and longitudinal path are created separately 
\subsubsection{Lateral path}
The lateral path is designed as a Dubins path, with start pose, $P_s$, at the point where the landing plan generation request was made, and final pose, $P_f$, at the start of the landing path. Dubins path was chosen since it can be followed by a \gls{uav}, and meet the requirement that the \gls{uav} enters the landing path with the correct heading.

The lateral path is constructed following the equations in section \ref{S:DubinsPath}, however the rotation direction in each circle must first be determined. The desired behaviour is to find the shortest path of the four different rotation pairs given in table \ref{Tb:DubinsTurningDirection}. The shortest path is determined by calculating the length of each variants, where the shortest is chosen. The resulting the path is shown in figure \ref{Fig:LateralPath}.
\begin{figure}[H]
	\centering
		\includegraphics[width=1\textwidth]{figs/SysPlot/DubinsPath.eps}
		\caption{Lateral Dubins path}
		\label{Fig:LateralPath}
\end{figure}

The construction of the lateral path consists of two arc with a straight line between the arcs. The arcs are constructed by first finding the start and finish heading defined as $\psi_0$ and $\psi_1$ respectfully:
\begin{subequations}
\begin{align}
\psi_0 &= \begin{cases}
\atan2(Y_s-Y_{cs},X_s-X_{cs}) & \text{if start circle} \\
\atan2(Y_{P_N}-Y_{cf},X_{P_N}-X_{cf}) & \text{otherwise}
\end{cases}\\
\psi_1 &= \begin{cases}
\atan2(Y_{P_\chi}-Y_{cs},X_{P_{\chi}}-X_{cs}) & \text{if start circle} \\
\atan2(Y_{f}-Y_{cf},X_{f}-X_{cf}) & \text{otherwise}
\end{cases}
\end{align}
\end{subequations}
Continuing the turn angle must be defined, which is the difference between $\psi_1$ and $\psi_0$. However the periodic behaviour of the unit circle must respected, including the rotation direction. The maximum turning angle becomes:
\begin{equation}
\psi_{max} = \begin{cases}
-|\psi_1 - \psi_0| & \text{if counter clockwise rotation and } \psi_1 - \psi_0 \leq 0 \\
-(2\pi - |\psi_1-\psi_0|) & \text{ if counter clockwise rotation and } \psi_1 - \psi_0 > 0 \\
|\psi_1 - \psi_0| & \text{if clockwise rotation and } \psi_1 - \psi_0 \geq 0 \\
(2\pi - |\psi_1-\psi_0|) & \text{ if clockwise rotation and } \psi_1 - \psi_0 < 0
\end{cases}
\end{equation}
where $\psi_1-\psi_0 \in(-\pi,\pi]$. From the maximum turning angle the angle step and number of angle segments in the arc can be determined:
\begin{subequations}
\begin{align}
h &= \frac{d_{arc}}{R} \\
N &= \ceil[\Bigg]{\frac{\text{sign}(\psi_{max})\psi_{max}}{h}} + 1 \\
h &= \text{sign}(\psi_{max})h
\end{align}
\end{subequations}
where $h$ is arc angle step and $N$ the total number of steps in the arc. The step angle must have the same sign as $\psi_{max}$ to ensure the correct rotation direction. Continuing the heading function $\psi(\varpi)$ can be defined as:
\begin{equation}
\psi(\varpi) = \begin{cases}
\psi_{max} & \varpi = N-1 \\
\varpi h & \text{otherwise}
\end{cases}
\end{equation}
where $\varpi = 1,...,N-1$. Finally the arc path can be defined as:
\begin{equation}
\mathbf{p}(\varpi) = \begin{bmatrix}
\mathbf{O}_c \\
\end{bmatrix} + R\begin{bmatrix}
\cos(\psi_0 + \psi(\varpi)) \\
\sin(\psi_0 + \psi(\varpi)) \\
\end{bmatrix}
\end{equation}
A summary of the lateral path is:
\begin{equation}
\mathbf{p}(i) = \begin{cases}
\begin{bmatrix}
\mathbf{O}_{cs} \\
\end{bmatrix} + R_s\begin{bmatrix}
\cos(\psi_{0} + \psi(\varpi)) \\
\sin(\psi_{0} + \psi(\varpi)) \\
\end{bmatrix} & \text{Start circle} \\
\begin{bmatrix}
\mathbf{O}_{cf} \\
\end{bmatrix} + R_f\begin{bmatrix}
\cos(\psi_{0} + \psi(\varpi)) \\
\sin(\psi_{0} + \psi(\varpi)) \\
\end{bmatrix} & \text{Finish circle}
\end{cases}
\end{equation}
where $i = \varpi_s + \varpi_f$ with $\varpi_s$ and $\varpi_f$ as the number of segments in the start and finish circle respectfully.
\subsubsection{Longitudinal path}
The longitudinal path is designed as a straight line along the lateral path, which results in a spiral path in the arcs created by the lateral path. The approach path hold a constant decent angle until the correct height is reached, which is defined as the start height for the landing path. The approach decent angle is then accused such that the correct height is reach. The approach decent angle is defined as:
\begin{equation}
\gamma_d = \begin{cases}
\atan2(\Delta z,||\mathbf{p}(i+1)-\mathbf{p}(i)||_2) & \text{if } \atan2(\Delta z,||\mathbf{p}(i+1)-\mathbf{p}(i)||_2)\leq \gamma_{d_{Max}} \\
\gamma_{d_{Max}}										& \text{otherwise}
\end{cases}
\end{equation}
where $\gamma_{d_{Max}}$ is the maximum decent angle for the approach path, and $\Delta z$ is defined as:
\begin{equation}
\Delta z = z_d-z(i)
\end{equation}
where $z_d$ is the $z$ component in $WP1$. Continuing the longitudinal path is given as:
\begin{equation}
\mathbf{r}(i+1) = \begin{bmatrix}
\mathbf{p}(i) \\
||\mathbf{p}(i+1)-\mathbf{p}(i)||_2\tan(\gamma_d)
\end{bmatrix}
\end{equation}
where $\mathbf{r}(i)$ is the landing path and 
$p = \begin{bmatrix}
x(i) & y(i)
\end{bmatrix}^T$ is the lateral path. The resulting height profile of the approach path is shown in figure \ref{Fig:HeightProfile}.
\begin{figure}[H]
	\centering
		\includegraphics[width=1\textwidth]{figs/SysPlot/heightProfile.eps}
		\caption{Height profile of the landing path}
		\label{Fig:HeightProfile}
\end{figure}
\paragraph{Spiral path}
The longitudinal path will in the case where the correct height is not reach enter a spiral such that the correct height is reached. The spiral keeps the same turn radius as the finish circle in the lateral path. The longitudinal path continues along the spiral until the correct height can be reached with and decent angle equal or less then $\gamma_{d_{Max}}$. Continuing an arc is created such that the path ends with the correct heading. The arc has the same rotation direction as the lateral path, with start point where the correct height was reached and end point of the start of the landing path. The complete approach path combined with the landing path is shown in figure \ref{Fig:LateralPath}.
\begin{figure}[H]
	\centering
		\includegraphics[width=1\textwidth]{figs/SysPlot/LandingPath.eps}
		\caption{Approach path connected to the landing path}
		\label{Fig:LandingPath}
\end{figure}
\section{Navigation system}
The navigation system consist of two position and velocity measurement system, where one is a high accurate positioning system and the other a reliable backup system. The high accurate positioning system apply \gls{rtk-gps}, which is able to provide high accurate position solution. The backup positioning system consist of a standard package of standalone \gls{gps} and Inertial Measurement Unit (IMU) together with a Kalman filter, which is a proven reliable system in Ardupilot together with a Pixhawk. Ardupilot and Pixhawk are explained further in section \ref{ss:ardupilot} and section \ref{ss:Pixhawk}. However the \gls{rtk-gps} is subject to drop out, which create a situation where the navigation system should switch to standalone \gls{gps} or wait for the \gls{rtk-gps} to return. A state machine has been created to handle the state switching between \gls{rtk-gps} and the external navigation data, which is navigation data from the Pixhawk. This is handled in two steps. The first is a short loss compensator stage, where the backup standalone \gls{gps} is compensated to get a position solution closer to the \gls{rtk-gps} solution. The second stage fully disconnect the \gls{rtk-gps}. First the term \gls{rtk-gps} will be further explained, together with typical error sources that affect a \gls{gnss} positioning system.
\subsection{Position estimation RTK-GPS}\label{ss:rtk-gps}
\acrfull{rtk-gps} is in \citep{misra2011global} section 7.2.2 defined as a rover that receive raw \gls{gnss} measurements from a reference receiver which is transmitted over a radio link. A key feature with \gls{rtk-gps} is that the rover is able to estimate the integer ambiguities while moving. The reference receiver is usually defined as a base station, and the integer ambiguity is the uncertainty of the number of whole phase cycles between the receiver and a satellite. With the measurements from the base station the rover is able to calculated the distance between itself and the base station, where the distance is referred to as a baseline. The length of the baseline affect the accuracy of the \gls{rtk-gps} solution, due to increased effect of atmospheric disturbance, which is further explain in \ref{Ss:Atmosphere}. However with a short baseline, e.g. $1-2 km$, the atmospheric condition can be considered equal for the base station and the rover, which keeps the solution  at centimetre level accuracy. The concept of \gls{rtk-gps} is depicted in figure \ref{figure:RTK}.
\begin{figure}[H]
	\centering
		\includegraphics[width=0.7\textwidth]{figs/DGPS.png}
		\caption{Concept figure of \acrfull{rtk-gps}}
		\label{figure:RTK}
\end{figure}
The ability for the rover to resolve the integer ambiguity is a key feature in \gls{rtk-gps}. A well used method was purposed in the article \citep{teunissen1994new} which decorrelate the integer ambiguities such that a efficient computation of the least square estimate can be performed. The search method is further explained in \citep{teunissen1995least}. A estimate of the integer ambiguity with sufficient high degree of certainty is referred to as a FIX solution, otherwise the solution is degraded to FLOAT where the integer ambiguity is allowed to be a decimal or a floating point number. When the solution is categorised as FIX the accuracy of the solution is considered on centimetre level, while with a FLOAT solution the accuracy is at a decimetre level. However when a FIX solution is lost, the solution accuracy will not imminently degrade to decimetre level.

In \gls{rtk-gps} the position of the base station must be resolved. This can be achieved by either knowing the position beforehand, which is defined as a kinematic configuration. If the base station position is unknown the \gls{rtk-gps} solver calculates the position on the fly, which is defined as a moving baseline configuration. The unknown position is then calculated as a standalone \gls{gnss} receiver, with the accuracy that entails. Therefore the \gls{rtk-gps} system with a moving baseline configuration can never have better global accuracy then what it will get with a single receiver. The advantage with the moving baseline configuration is that the base station is allowed to moved, and with \gls{rtk-gps} the relative position between the rover and base station can be determined in real time. This will be the case in automatic ship landing system, where the base station is on a ship, thus must be allowed to move. The advantage with kinematic mode is that it can give a more accurate position estimate, however this require that the base station is known and stationary.
\subsubsection{Error sources}
In order to get high accuracy in the position estimation the different error sources must be identified and removed if possible. This section will identify some of the most significant error sources that can affect the \gls{gnss} signal, and how to remove or mitigate them in the estimation.
\paragraph{Clock error}
There is drift in both the satellite clock and the receiver clock. The atomic clock in the satellites makes the clock drift negligible from the user perspective. The receiver clock tend to drift, and if not taken into account will cause large deviations in the position estimate from the true position. This error is remove by including a fourth satellite in the position computation. The satellite clock error is given in the satellite message. 

\paragraph{Ionospheric and tropospheric delays}\label{Ss:Atmosphere}
When the \gls{gps} signals travel though the atmosphere there will be a delay caused by the different atmospheric layers. The atmosphere change the velocity of wave propagation for the radio signal, which results in altered transit time of the signal.
\paragraph{Ionospheric delay}
Gas molecules in the ionosphere becomes ionized by the ultraviolet rays that is emitted by the sun, which release free electrons. These electron can influence electromagnetic wave propagation, such as \gls{gnss} signals. In \citep{vik2014integrated} section 3.5.1 it's stated that the delay caused by the ionosphere usually is in the order of $1-10 $meters. The error can be mitigated by using a double frequency receiver, or by applying a mathematical model to estimate the delay. Both those methods are with a single receiver, however by including a second receiver in a network, e.g. \gls{rtk-gps}, the \gls{gnss} solution system can assume that both receiver receive signal in the same epoch, which means that the signals have experienced the same delay. The rover is then able to remove the error induced from ionospheric disturbance.
\paragraph{Tropospheric delay}
The tropospheric delay is a function of the local temperature, pressure and relative humidity. The effect of tropospheric delay can  vary from $2.4$ meters to $25$ meters depending on the elevation angle of the satellites,\citep{vik2014integrated} section 3.5.1. The error can be mitigated by applying a mathematical model to estimate the tropospheric delay, or by using a elevation mask can remove all satellites with a elevation angle bellow a certain threshold. Similar to ionospheric delay, tropospheric delay can be removed when using two receivers in a network by assuming that the single received by both receivers has experienced the same delay. 
The tropospheric delay is a function of the local temperature, pressure and relative humidity. The effect of tropospheric delay can  vary from $2.4$ meters to $25$ meters depending on the elevation angle of the satellites,\citep{vik2014integrated} section 3.5.1. The error can be mitigated by applying a mathematical model to estimate the tropospheric delay, or by using a elevation mask can remove all satellites with a elevation angle bellow a certain threshold. Similar to ionospheric delay, tropospheric delay can be removed when using two receivers in a network by assuming that the single received by both receivers has experienced the same delay. 

\paragraph{Multipath}
One of the primary source of error in in a \gls{gnss} receiver is multipath. Multipath happens when the satellite signal is reflected by a nearby surface before if reach the \gls{gnss} antenna. The delay introduced in the signal can make the receiver believe that its position is several meters away form its true position. The easiest way to mitigated multipath is to place the antenna at a location with open skies, with no tall structures nearby. The effect can also be mitigated by choosing a antenna with good multipath rejection capability.

Multipath error uncorrelated between receivers, thus the local receiver must be able to correct for multipath error locally.

\subsection{Navigation state control system}\label{S:NavState}
The navigation state control system manage the current state of the navigation system, which controls if the \gls{rtk-gps} usage and responsible of dispatching the current state of the \gls{uav} to the rest of the DUNE system. The structure of the navigation state control system is shown in figure \ref{Fig:NavState}, with edge description given in table \ref{Tb:Nav state edge}. The basic state of the navigation system function as if the \gls{rtk-gps} system is not available, which makes the navigation system independent from the \gls{rtk-gps} system. This is a requirement for the navigation system since it should function in a \gls{uav} where \gls{rtk-gps} is not present.

In order for the navigation system to switch state into "Rtk ready" the \gls{rtk-gps} message must contain a valid base position, which must be set by the user. The setting of the base station is specified further in section \ref{ss:RTK-GPS system}. In addition the \gls{rtk-gps} solution type must be valid for $x$ seconds such that a stable desired solution type is available.

The navigation state control system will only use the \gls{rtk-gps} system if the user has configured the navigation system to apply \gls{rtk-gps} and if it's available. 

The state machine can enter a state during loss of \gls{rtk-gps}, where the position solution from the Pixhawk is compensated with the average difference between the \gls{rtk-gps} position solution and the Pixhawk solution. This state will be further explained in section \ref{ss:ShortLoss}.
\newpage
\begin{figure}[H]
\def\svgwidth{\textwidth} % Defining the width since Inkscape hasn't done this yet in the .pdf_tex file
\input{InkFig/StateMachine.pdf_tex}
\caption{State machine in the DUNE Navigation task}
\label{Fig:NavState}
\end{figure}
\begin{table}[H]

    \begin{tabular}{ | p{1cm} | p{8cm} | | p{4cm} |}
    \hline
    \textbf{Edge} 	& \textbf{Event} 																	& \textbf{Guard} \\ \hline
    A 				& Event: Received External Nav message 												& None \\ \hline
    B 				& Time out: Fix \gls{rtk-gps} solution for $x$ seconds with valid base position 	& None \\ \hline
    C 				& Time out: $x$ seconds since last valid GpsFixRtk 									& None \\ \hline
    D 				& Flag: Using Rtk is set true														& None \\ \hline
    E 				& Flag: Using Rtk is set false														& None \\ \hline
    F 				& Time out: $x$ seconds since last valid GpsFixRtk 									& Short loss compensator:\\ 
      				& Event: Received GpsRtkFix with $\text{type}==\text{None}$ 						& Enabled\\ \hline
    G 				& Event: Received valid GpsFixRtk message											& None \\ \hline
    H 				& Time out: $x$ seconds since last valid GpsFixRtk 									& Short loss compensator:\\
    				& Event: Received GpsRtkFix with $\text{type}==\text{None}$							& Disabled \\ \hline
    I 				& Time out: $x$ seconds since last valid GpsFixRtk 									& None \\ \hline
    \end{tabular}

\caption{Description of the edges used in the state machine}
\label{Tb:Nav state edge}
\end{table}
The state machine is designed to alter behaviour when the state machine enters a new state, with the entries action listed in table \ref{Tb:EntryAction}. A summary of the states in the navigation state control system is given in table \ref{Tb:StateDescription}.
\begin{table}[H]
\begin{tabular}{ | p{3cm} | p{8cm} |}
	\hline 
	\textbf{State}						& \textbf{Description} \\ \hline
	Initialize							& The task starting up\\ \hline
	Using external						& The navigation task apply the external navigation source in the state message\\ \hline
	RTK ready							& The \gls{rtk-gps} is ready for use, however the external navigation source is still used\\ \hline
	Using RTK							& The navigation task apply the \gls{rtk-gps} in the state message\\ \hline
	Using short RTK loss compensator	& The navigation task apply the external navigation source with a compensation term to reduce the effect of \gls{rtk-gps} loss. \\ \hline
\end{tabular}
\caption{States in the navigation system with description}
\label{Tb:StateDescription}
\end{table}

\begin{table}[H]
\begin{tabular}{ | p{3cm} | p{8cm} |}
	\hline 
	\textbf{State}						& \textbf{Entry action} 										\\ \hline
	Initialize							& Start up for the navigation state control system				\\ \hline
	Using external						& \gls{rtk-gps} is disabled										\\
										& Availability activation timer for \gls{rtk-gps} is started 	\\
										& State of navigation system is updated							\\ \hline
	RTK ready							& \gls{rtk-gps} is disabled										\\
										& Availability deactivation timer for \gls{rtk-gps} is started	\\
										& State of navigation system is updated							\\ \hline
	Using RTK							& \gls{rtk-gps} is enabled										\\
										& State of navigation system is updated							\\
										& If short RTK loss compensator is activated:					\\
										&	- Short RTK loss compensator activation timer is started		\\
										& If short RTK loss compensator is deactivated:					\\
										& 	- \gls{rtk-gps} time out timer is started						\\ \hline
	Using short RTK loss compensator	& Short RTK loss compensator deactivation timer is started		\\ \hline
\end{tabular}
\caption{Entry action for each state}
\label{Tb:EntryAction}
\end{table}
\subsubsection{Short loss of RTKGPS}\label{ss:ShortLoss}
In order for the navigation system to handle short loss of \gls{rtk-gps} a short loss \gls{rtk-gps} system is presented. The compensator is based on that the position solution from the external navigation system is almost constant with respect to the \gls{rtk-gps} solution. Therefore the average difference between the \gls{rtk-gps} position solution and the external navigation system should be able to move the external navigation position solution closer to the \gls{rtk-gps} position solution. The short loss compensator is given as:
\begin{align}
\mathbf{e}(n) &= \mathbf{p}_1(n) - \mathbf{p}_2(n)\\
\mathbf{\delta} &= \frac{1}{N}\sum_{n=0}^N(\mathbf{e}(n))
\end{align}
where $\mathbf{p}_1(n)$ and $\mathbf{p}_2(n)$ is the position solution sample for the \gls{rtk-gps} system and the external navigation system respectfully. $N$ is the total number of samples with $n\in [0,N-1]$ as the counting variable. Adding $\mathbf{\delta}$ to the external navigation position with the assumption of slow varying bias between the two position solution gives:
\begin{equation}
\mathbf{p}_2(t) + \mathbf{\delta} \rightarrow \mathbf{p}_1(t)
\end{equation}
where $\mathbf{p}_1(n)$ and $\mathbf{p}_2(n)$ is the current position solution for the \gls{rtk-gps} system and the external navigation system respectfully. The short loss \gls{rtk-gps} compensator will trigger if there is a delay in the \gls{rtk-gps} system, or a temporary drop out occur. The output frequency of the short loss compensator is set to be the same as the \gls{rtk-gps} system, which is estimate by comparing the time each \gls{rtk-gps} message is dispatched. This results in prolonging the time where the \gls{rtk-gps} is available for the navigation system, and will ensure that the navigation system outputs at a stable frequency. The goal with the compensator is to prevent mission abortion, and make the \gls{rtk-gps} system more robust.