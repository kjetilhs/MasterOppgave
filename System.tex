\chapter{System}

\section{Navigation system}
The navigation system apply RTKGPS for position and velocity measurement. The output from the RTKGPS software contains only the relative position from the base station, and not the position of the base station. Therefore a task was created to send send the global base station location to the navigation system, which enable the rest of the system to calculate the global position of the uav. 

The base station position is received in the RTKGPS task in DUNE, were it's included in the GpsFixRtk message.

A task in the nest receive the gps position of the base, and the operator can monitor it in neptus. When the operator choose to fix the base station gps position a parameter update is send to the task, which will start to send a gpsfixrtk message to the uav. 

TODO: Create figure that shows the information flow that is used to create the rtkfix message.
\subsection{Operator interface}
The operator use the Neptus platform as operational interface during the landing. The console includes information about the position of the uav, as well as the source of the position measurement. The operator can monitor the status of the gps system, including what is accepted by the navigation system. During a autonmous landing the operator must be fully aware of the status of the navigation system, such that an abort due to lost gps fix. This system can be expanded to include other sensors, like a ranging system, IMU, camera ex.
\subsection{Position correction}%Flytt til resultat
The highly dynaimcal nature of the uav create a challenge for the navigation system due to the blocking of the gps antenna from the satellite constellation. The problem was reduced by using a gps receiver that has a high performance in satellite tracking, however this does not remove the problem. A float solution from the gps system is valid for some seconds after fix is lost, due to the predictive nature of the Extended Kalman filter in rtklib. However after a seartin amount of time the navigation system swithces over to use the position estimate from the pixhawk, which has a lower accuracy level then the rtk gps system. To increase the accuracy level a offset solution is proposed. By calculating the difference between the fixed rtk gps solution and the position solution from the pixhawk a offset can be found. If the offset can be assumed constant or quasi stationary it can be used to increase to accuracy level for the navigation system enough to allow for completion of critical phases of a manoeuvre. However tests showed that the offset was not constant nor quasi stationary. By applying the offset to the pixhawk position solution the accuracy level will increase, but not enough to allow for execution of critical manoeuvres.
In order to make the navigation system more robust, some methods was explored. 
\section{Path generation}
The landing path is design with the assumption that the aerial space in which the uav operates is limited. The limitation can be the range of the uav, regulatory limits or weather. In addition the autonomous landing system must be able to perform a safe landing from any initial position. Furthermore the size of the virtual run way should be constructed by the operator. The type of uav operation dictates the maximum size of the landing path. Different types of uav operation is LOS, ELOS, BLOS and BRLOS. Only the first is considered in this thesis, which means that the pilot must have the uav in view during the entire flight. The operator must also be able to control the angle which the uav is descending, which means that the height of the landing path is fixed. Therefore the uav must be at the correct altitude before it can start descending toward the landing net.

A landing algorithm that is proposed consist of glideslopes that forms a staircase, of which the uav can ascend or descend in order to reach the correct heigh to start the landing. The path itself consist of straight lines between waypoints, however the landing path is not generated for a specific controller.

TODO: INSERT ALGORITHM HERE 

The controller apply a goto manoeuvre in DUNE, which make a path manager task responsible for following the path. The advantage with this approach is the use of a module that has been thoroughly tested, which limits the source of error is the guidance system. The disadvantage is the path is picewise continues, which will introduce sudden changes in desired state for the controller. A curved path will remove this behaviour, however this will required a controller which is created specially for this path. I addition the autonomous landing achieved in \citep{Skulstad&Syversen} was performed with a straight line path.

\section{Evasion}
To ensure the safety of the operator a evasion controller is used to abort the landing when a successful landing is deemed infeasible or improbable.

\section{Guidance system}
The guidance system consist of two part. Sliding mode controller, and a los controller

\subsection{Sliding mode controller}
For course control the system use a sliding mode controller that was proposed in the paper \citep{fortuna2015cascaded}, which USGES stability property.
\begin{subequations}
\begin{align}
\dot{x} &= V_a\cos(\psi) + W_x = V_g\cos(\psi) \\
\dot{y} &= V_a\sin(\psi) + W_y = V_g\sin(\psi) \\
\dot{phi} &= \frac{g}{V_a}\tan(\varphi) \\
\dot{\varphi} &= -\frac{\varphi-\varphi_{cmd}}{T_\varphi} \\
W &= \sqrt{W_x^2 + W_y^2}
\end{align}
\end{subequations}
\begin{equation}
\epsilon(\varphi) = \begin{cases}
\cos(\varphi), & \text{if}\ |\cos(\varphi)|\geq\epsilon'\\
\epsilon', & \text{if}\ 0 \leq \cos(\varphi) < \epsilon' \\
-\epsilon', & \text{if} -\epsilon'<\cos(\varphi) < 0
\end{cases}
\end{equation}
\begin{equation}
\chi = \tan^{-1}(\frac{\dot{y}}{\dot{x}})
\end{equation}
\begin{equation}
\dot{\chi} = \frac{g\sin(\varphi)(V_a + \cos(\psi)W_x + \sin(\psi)W_y}{\epsilon(\varphi)V_g^2}
\end{equation}
\begin{subequations}
\begin{align}
\chi_d &= \tan^{-1}(-\frac{t}{\Delta} \\
\dot{\chi_d} &= -\frac{\Delta}{\Delta^2+y^2}\dot{y} \\
\ddot{\chi} &= \frac{\Delta}{(\Delta^2 + y^2)^2}(2y\dot{y}^2 - (\Delta^2 + y^2)\ddot{y})
\end{align}
\end{subequations}
\begin{equation}
\tilde{\chi} = \chi - \chi_d
\end{equation}
\begin{equation}
s = \dot{\tilde{\chi}} + \lambda\tilde{\chi}
\end{equation}
\begin{equation}
u = -\lambda\dot{\tilde{\chi}} - \rho\text{sgn}(s) - K_ds
\end{equation}