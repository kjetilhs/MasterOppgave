\chapter{Implementation}
The navigation and landing path system is implemented in DUNE, and monitored in Neptus. The implementation that will be more closely explained is the modules related to the navigation and landing path system. The control and guidance system is not part of this thesis, however recommendation will be mentioned on types of controllers able to follow the landing path with satisfying accuracy. A simplified version of the DUNE navigation, landing and control system connected to ardupilot is  shown in figure \ref{fig:DuneSystem}.
\newpage
\begin{figure}[H]
	\centering
		\includegraphics[width=1\textwidth]{figs/DUNESystem.png}
		\caption{A simplified figure of the Dune auto land system}
		\label{fig:DuneSystem}
\end{figure}
\section{Landing path}
The landing path system is implemented in the DUNE task LandingPlan, which is design to start generation of a approach and landing path when receiving the \gls{imc} message LandingPlanGeneration.  The \gls{imc} message was created to structure the parameter needed to construct a flyable approach and landing path. As part of the \gls{imc} message is the ability to specify the rotation direction of the start and finish circle, as well as if there should be a loiter point in the end of the approach path. The ability to specify the rotation direction of the start and final turning circles ensures that the path can be created to take into account environmental obstacles or wind directions. However if all four variants of the approach path is valid, then the shortest path can be chosen by setting the "Automatic" parameter in the LandingPlanGeneration message true. 

The ability to have a loiter manoeuvre at the end of the approach path gives flexibillity when performing a net landing. It allows for final checks of the net condition, or can be used in a dynamic landing operation where the net not stationary e.q. placed on a ship or carried by multi-copters. When configuration the LandingPlan task to perform a dynamical landing only the approach path is created. This was found out to be a preferable solution since a dynamical landing require a feedback loop to correct the desired path, which is currently not included in the landing path system. A solution for performing a dynamical landing is currently research by fellow Master students where the multi-copters is used to catch the \gls{uav}, where this landing system is used to create a approach path to ready the \gls{uav} for a dynamic landing.

The approach path is created as a FollowPath manoeuvre, which is a manoeuvre with a reference position and offset points that displaced relative to the reference position. The distance between each offset point in each arc is given as a task configuration parameter named "Distance Between Arc Segments"
\subsection{Neptus plug-in}
From Neptus the plug-in LandmapLayer, which is an altered version of Neptus plug-in developed in thesis \citep{Froelich}. Alteration in the plug-in include new parameters, the inclusion of the \gls{imc} message LandingPlangeneration and the ability to manually write the global position coordinates of the net.
\begin{table}
\centering
\begin{tabular}{| p{2.7cm} | | p{6cm} |}
\hline
\textbf{Parameter name} 							& \textbf{Description} \\ \hline
 Automatic (boolean)								& If true a standard path where the shortest Dubins path is chosen. Otherwise a user specific path is chosen \\ \hline
Start circle turning counter clockwise (boolean)	& If true the start arc is created such that the turning direction is counter clockwise. Otherwise clockwise. Require Automatic==false \\ \hline
Finish circle turning counter clockwise (boolean)	& If true the finish arc is created such that the turning direction is counter clockwise. Otherwise clockwise. Require Automatic==false \\ \hline
Wait at loiter (boolean)							& If true a unlimited loiter is included in the path before the path continue with the path along the virtual runway. \\ \hline

\end{tabular}
\caption{Landing path behaviour setting in LandingPlanGeneration}
\label{Tb:DubinConfig}
\end{table}
\section{Navigation system}
The navigation system is control by a state machine \ref{S:NavState}, which is used to control the content of the output \gls{imc} messages EstimatedState and NavSources. Depending on which state the navigation system is in the \gls{imc} EstimatedState message will either have position solution form the \gls{rtk-gps} system or the external navigation system. During a short loss of the RTK the external navigation position is compensated with the average difference between the RTK solution and the external navigation solution.
\subsection{RTK-GPS system}\label{ss:RTK-GPS system}
The \gls{rtk-gps} solution is dispatched from the DUNE task RTKGPS, however before the message is accepted by the Navigation task the message must include a valid base station position. The base station position is not included in the output message from RTKlib, which demand the base station position to be calculated locally at the base station as a standalone \gls{gnss} receiver. For this purpose the DUNE task BasestationFix is used to lock the current position of the base station, which result in the base station position being transmitted to the RTKGPS task.
The navigation system require to now the reference position of the base station in order to use the \gls{rtk-gps} solution. However the base station position is currently not part of the output message from rtkrcv. This is resolved by allowing the base station to calculate it's own position as a standalone \gls{gps}. The \gls{gps} position is transmitted to a local Dune task on the base station, where the operator can decide when the base station can be considered as fixed. When the base station is considered fixed the position is sent to the X8, where it's included in the \gls{rtk-gps} solution message.
\subsection{State machine}
\subsubsection{Nest system}
A nest system is a stationary unit with the sole purpose of providing it's position to the rest of the Dune System. As part of the navigation system the base station is defined as a nest, where the \gls{gps} position is sent to the \gls{rtk-gps} system when fixed.
An other nest has been created to obtain the \gls{gps} position of the stationary net. The net nest is configured as a rover in \gls{rtk-gps} configuration, such that the position relative to the base station is in the same frame as the X8.
\subsection{Operator interface}
The state of the navigation system is monitored though a interface in Neptus. The interface indicate which source the Dune system is using for state information. The interfaced apply a color code to indicate which source is currently in use in addition to all sensor system that are available, as seen in table \ref{Tb:Color Code}.
\begin{table}[H]
\begin{center}
    \begin{tabular}{ | l | l |}
    \hline
    \textbf{Color} & \textbf{Description} \\ \hline
    White & Not available \\ \hline
    Yellow & Available, but not in use \\ \hline
    Green & Available, and in use \\ \hline
    \end{tabular}
\end{center}
\caption{Net approach parameters }
\label{Tb:Color Code}
\end{table}